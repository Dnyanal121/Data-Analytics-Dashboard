<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Visualization</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <style>
    body { background-color: #f8f9fa; }
    .form-card { border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
  </style>
</head>

<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-light bg-white shadow-sm mb-4">
    <div class="container">
      <a class="navbar-brand fw-bold text-primary" href="{{ url_for('operation') }}">
        <i class="bi bi-bar-chart-line"></i> Visualization
      </a>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('operation') }}">
        Back to Menu
      </a>
    </div>
  </nav>

  <main class="container">

    <!-- DATASET SELECTOR -->
    <div class="card form-card mb-4">
      <div class="card-header bg-white fw-bold">
        <i class="bi bi-folder2-open"></i> Load Dataset
      </div>
      <div class="card-body">
        <form method="POST">
          <div class="row align-items-end">
            <div class="col-md-6">
              <label class="form-label small fw-bold text-uppercase text-muted">
                Select Dataset
              </label>
              <select name="dataset" id="dataset" class="form-select">
                <option value="">-- Choose Dataset --</option>
                {% for f in files %}
                  <option value="{{ f }}" {% if f==selected_file %}selected{% endif %}>{{ f }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3 mt-3">
              <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-arrow-clockwise"></i> Load
              </button>
            </div>
          </div>
        </form>

        <!-- {% if selected_file %}
        <hr>
        <h6 class="fw-bold">Preview of {{ selected_file }}</h6>
        <div class="table-responsive">
          {{ preview_html | safe }}
        </div>
        {% endif %} -->
      </div>
    </div>

    <div class="row">
      <!-- LEFT SIDE : Plot Controls -->
      <div class="col-lg-4 mb-4">
        <div class="card form-card h-100">
          <div class="card-header bg-white fw-bold">
            <i class="bi bi-sliders"></i> Plot Controls
          </div>
          <div class="card-body">

            <form method="POST" id="viz-form">
              <input type="hidden" name="dataset" value="{{ selected_file }}">

              <!-- ANALYSIS TYPE -->
              <div class="mb-3">
                <label class="form-label small fw-bold text-uppercase text-muted">Analysis Type</label>
                <select id="analysis_type" name="analysis_type" class="form-select" onchange="onAnalysisChange()">
                  <option value="">-- Select --</option>
                  <option value="univariate">Univariate</option>
                  <option value="bivariate">Bivariate</option>
                  <option value="multivariate">Multivariate</option>
                  <option value="time_series">Time Series</option>
                </select>
              </div>

              <div id="x_div" class="mb-3" style="display:none;">
                <label class="form-label small fw-bold text-uppercase text-muted">X Column</label>
                <select id="x_select" name="x" class="form-select"></select>
              </div>

              <div id="y_div" class="mb-3" style="display:none;">
                <label class="form-label small fw-bold text-uppercase text-muted">Y Column</label>
                <select id="y_select" name="y" class="form-select"></select>
              </div>

              <div id="z_div" class="mb-3" style="display:none;">
                <label class="form-label small fw-bold text-uppercase text-muted">Z Column</label>
                <select id="z_select" name="z" class="form-select"></select>
              </div>

              <div id="multi_div" class="mb-3" style="display:none;">
                <label class="form-label small fw-bold text-uppercase text-muted">Select Multiple Columns</label>
                <select id="multi_select" name="multi_cols" class="form-select" multiple size="6"></select>
              </div>

              <!-- CHART TYPE -->
              <div id="chart_div" class="mb-3" style="display:none;">
                <label class="form-label small fw-bold text-uppercase text-muted">Chart Type</label>
                <select id="chart_select" name="chart_type" class="form-select" onchange="onChartChange()"></select>
              </div>

              <button class="btn btn-primary w-100">
                <i class="bi bi-bar-chart"></i> Generate Plot
              </button>
            </form>

          </div>
        </div>
      </div>

      <!-- RIGHT SIDE : Plot -->
      <div class="col-lg-8">
        <div class="card form-card h-100">
          <div class="card-body p-2 d-flex align-items-center justify-content-center bg-white rounded">
            {% if plot_html %}
              <div class="w-100">
                {{ plot_html | safe }}
              </div>
            {% else %}
              <div class="text-center text-muted py-5">
                <i class="bi bi-bar-chart-line display-1 opacity-25"></i>
                <p class="mt-3">
                  {% if selected_file %}
                    Select parameters and click Generate Plot.
                  {% else %}
                    Select a dataset to begin.
                  {% endif %}
                </p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

  </main>


<!-- ======== JAVASCRIPT (YOUR ORIGINAL FULL JS) ========= -->
<script>
  const numericCols = {{ numeric_cols | tojson | default([]) }};
  const categoricalCols = {{ categorical_cols | tojson | default([]) }};
  const dateTimeCols = {{ date_time_cols | tojson | default([]) }};

  const options = {
    univariate: [
      {v:"hist",t:"Histogram"}, {v:"kde",t:"Density Plot"}, 
      {v:"box",t:"Box Plot"}, {v:"violin",t:"Violin Plot"},
      {v:"count",t:"Count Plot"}, {v:"pie",t:"Pie Chart"}
    ],
    bivariate: [
      {v:"scatter",t:"Scatter Plot"}, {v:"bubble",t:"Bubble Plot"},
      {v:"line",t:"Line Plot"}, {v:"bar",t:"Bar Chart"},
      {v:"hexbin",t:"Hexbin Plot"}, {v:"regression",t:"Regression"},
      {v:"joint",t:"Joint Plot"}
    ],
    multivariate: [
      {v:"heatmap",t:"Correlation Heatmap"}, {v:"pairplot",t:"PairPlot"},
      {v:"parallel",t:"Parallel Coordinates"}, {v:"3d_scatter",t:"3D Scatter"}
    ],
    time_series: [
      {v:"ts_line",t:"Time Series Line"}, {v:"decomposition",t:"Seasonal Decomposition"},
      {v:"acf_pacf",t:"ACF / PACF"}, {v:"rolling_mean",t:"Rolling Mean"},
      {v:"candlestick",t:"Candlestick Plot"}
    ]
  };

  function fillSelect(select, items) {
    select.innerHTML = "";
    items.forEach(c => {
      const o = document.createElement("option");
      o.value = o.text = c;
      select.appendChild(o);
    });
  }

  function onAnalysisChange() {
    const type = document.getElementById("analysis_type").value;

    document.getElementById("x_div").style.display = "none";
    document.getElementById("y_div").style.display = "none";
    document.getElementById("z_div").style.display = "none";
    document.getElementById("multi_div").style.display = "none";
    document.getElementById("chart_div").style.display = "none";

    if (!type) return;

    document.getElementById("chart_div").style.display = "block";
    setChartOptions(type);

    if (type === "univariate") {
      document.getElementById("x_div").style.display = "block";
      fillSelect(document.getElementById("x_select"), numericCols.concat(categoricalCols));

    } else if (type === "bivariate") {
      document.getElementById("x_div").style.display = "block";
      document.getElementById("y_div").style.display = "block";
      fillSelect(document.getElementById("x_select"), numericCols.concat(categoricalCols));
      fillSelect(document.getElementById("y_select"), numericCols);

    } else if (type === "multivariate") {
      // Handle inside chart change
    } else if (type === "time_series") {
      document.getElementById("x_div").style.display = "block";
      document.getElementById("y_div").style.display = "block";

      fillSelect(document.getElementById("x_select"), dateTimeCols);
      fillSelect(document.getElementById("y_select"), numericCols);
    }

    onChartChange();
  }

  function onChartChange() {
    const chart = document.getElementById("chart_select").value;
    const analysis = document.getElementById("analysis_type").value;

    const xDiv = document.getElementById("x_div");
    const yDiv = document.getElementById("y_div");
    const zDiv = document.getElementById("z_div");
    const multiDiv = document.getElementById("multi_div");

    const xSel = document.getElementById("x_select");
    const ySel = document.getElementById("y_select");
    const zSel = document.getElementById("z_select");
    const multiSel = document.getElementById("multi_select");

    if (analysis === "univariate") {
      yDiv.style.display = "none";
      zDiv.style.display = "none";
      multiDiv.style.display = "none";

      if (["hist","kde","box","violin","pie"].includes(chart))
        fillSelect(xSel, numericCols);
      if (chart === "count")
        fillSelect(xSel, categoricalCols);
    }

    else if (analysis === "bivariate") {
      zDiv.style.display = "none";
      multiDiv.style.display = "none";

      if (["scatter","line","regression","hexbin","joint"].includes(chart)) {
        fillSelect(xSel, numericCols);
        fillSelect(ySel, numericCols);
      }
      if (chart === "bar") {
        fillSelect(xSel, categoricalCols);
        fillSelect(ySel, numericCols);
      }
      if (chart === "bubble") {
        zDiv.style.display = "block";
        fillSelect(xSel, numericCols);
        fillSelect(ySel, numericCols);
        fillSelect(zSel, numericCols);
      }
    }

    else if (analysis === "multivariate") {
      if (["heatmap","pairplot","parallel"].includes(chart)) {
        xDiv.style.display = "none";
        yDiv.style.display = "none";
        zDiv.style.display = "none";
        multiDiv.style.display = "block";
        fillSelect(multiSel, numericCols);
      }

      if (chart === "3d_scatter") {
        xDiv.style.display = "block";
        yDiv.style.display = "block";
        zDiv.style.display = "block";
        multiDiv.style.display = "none";

        fillSelect(xSel, numericCols);
        fillSelect(ySel, numericCols);
        fillSelect(zSel, numericCols);
      }
    }

    else if (analysis === "time_series") {
      multiDiv.style.display = "none";
      zDiv.style.display = "none";
      yDiv.style.display = "block";

      fillSelect(xSel, dateTimeCols);
      fillSelect(ySel, numericCols);

      if (chart === "candlestick") {
        yDiv.style.display = "none";
        multiDiv.style.display = "block";
        fillSelect(multiSel, numericCols);
      }
    }
  }

  function setChartOptions(a) {
    const cs = document.getElementById("chart_select");
    cs.innerHTML = "";
    if (options[a]) {
      options[a].forEach(o => {
        let opt = document.createElement("option");
        opt.value = o.v;
        opt.text = o.t;
        cs.appendChild(opt);
      });
    }
  }

  document.addEventListener("DOMContentLoaded", onAnalysisChange);
</script>

</body>
</html>
