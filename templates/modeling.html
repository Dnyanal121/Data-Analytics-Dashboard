<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Modeling</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <nav class="navbar navbar-light bg-white shadow-sm mb-4">
    <div class="container">
      <a class="navbar-brand" href="#">ML Modeling</a>
      <div>
                <a href="{{ url_for('operation') }}" class="btn btn-secondary">Back to Menu</a>
      </div>
    </div>
  </nav>

  <main class="container">

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% if not selected_file %}
      <div class="alert alert-warning">
        Please <a href="{{ url_for('visualization_page') }}">select a dataset</a> on the visualization page first.
      </div>
    {% else %}
      <h4 class="mb-3">Train a Model on <strong>{{ selected_file }}</strong></h4>

<!-- Data Selection -->
      <form method="POST" class="mb-4">
        <div class="row align-items-end">
          <div class="col-md-6">
            <label for="dataset" class="form-label">Select Dataset:</label>
            <select name="dataset" id="dataset" class="form-select" required>
              <option value="">-- Choose Dataset --</option>
              {% for file in files %}
                <option value="{{ file }}" {% if file == selected_file %}selected{% endif %}>{{ file }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <button type="submit" class="btn btn-primary">Load Dataset</button>
          </div>
        </div>
    </form>
      
      <form method="POST" id="model-form">
        <div class="row g-3">

          <div class="col-md-6">
            <label for="problem_type" class="form-label"><strong>1. Problem Type</strong></label>
            <select id="problem_type" name="problem_type" class="form-select" onchange="onProblemTypeChange()">
              <option value="">-- Select Problem Type --</option>
              <option value="regression" {% if selected_options.problem_type == 'regression' %}selected{% endif %}>Regression (Predict a Number)</option>
              <option value="classification" {% if selected_options.problem_type == 'classification' %}selected{% endif %}>Classification (Predict a Category)</option>
            </select>
          </div>

          <div class="col-md-6">
            <label for="model_name" class="form-label"><strong>2. Select Model</strong></label>
            <select id="model_name" name="model_name" class="form-select">
              <option value="">-- Select Problem Type First --</option>
            </select>
          </div>
          
          <div class="col-md-6">
            <label for="target" class="form-label"><strong>3. Target Variable (Y)</strong></label>
            <select id="target" name="target" class="form-select" onchange="onTargetChange()">
              <option value="">-- Select Problem Type First --</option>
            </select>
          </div>
          
          <div class="col-md-6">
            <label for="features" class="form-label"><strong>4. Feature Variables (X)</strong></label>
            <select id="features" name="features" class="form-select" multiple size="8">
              </select>
          </div>

          <div class="col-12">
            <button class="btn btn-success mt-2" type="submit" name="form_action" value="train">Train Model</button>
          </div>
        </div>
      </form>

      {% if model_results %}
        <hr class="my-4">
        <h4 class="mb-3">Model Results</h4>
        
        {% if model_results.error %}
          <div class="alert alert-danger">{{ model_results.error }}</div>
        {% else %}
          <div class="card">
            <div class="card-header">
              <strong>{{ model_results.model_name }}</strong> ({{ model_results.problem_type | capitalize }})
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <h5>Metrics</h5>
                  <ul class="list-group">
                    {% for key, value in model_results.metrics.items() %}
                      <li class="list-group-item d-flex justify-content-between align-items-center">
                        <strong>{{ key }}</strong>
                        <span class="badge bg-primary rounded-pill fs-6">{{ value }}</span>
                      </li>
                    {% endfor %}
                  </ul>

                  <h5 class="mt-4">Inputs</h5>
                  <ul class="list-group list-group-flush">
                    <li class="list-group-item"><strong>Target:</strong> {{ model_results.target }}</li>
                    <li class="list-group-item"><strong>Features:</strong> {{ model_results.features }}</li>
                  </ul>
                </div>

                <div class="col-md-6">
                  {% if model_results.plot_html %}
                    <h5 class="mb-3">Feature Importance</h5>
                    {{ model_results.plot_html | safe }}
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="card-footer bg-white">
              <form method="POST">
                <input type="hidden" name="problem_type" value="{{ selected_options.problem_type }}">
                <input type="hidden" name="target" value="{{ selected_options.target }}">
                <input type="hidden" name="model_name" value="{{ selected_options.model_name }}">
                {% for f in selected_options.features %}
                  <input type="hidden" name="features" value="{{ f }}">
                {% endfor %}
                
                <input type="hidden" name="form_action" value="save_model"> 
                
                <label class="form-label"><strong>Save this Model</strong></label>
                <div class="input-group">
                  <input type="text" name="save_name" class="form-control" placeholder="Enter a unique model name (e.g., IrisClassifier)" required>
                  <button type="submit" class="btn btn-primary">Save Model</button>
                </div>
              </form>
            </div>
          </div>
        {% endif %}
      {% endif %}
      
    {% endif %}

  </main>

<script>
  // --- Data from Flask ---
  const allCols = {{ (numeric_cols + categorical_cols + date_time_cols) | tojson | default([]) }};
  const numericCols = {{ numeric_cols | tojson | default([]) }};
  const categoricalCols = {{ categorical_cols | tojson | default([]) }};
  // VVVV ADD THIS NEW LINE VVVV
  const classificationTargetCols = {{ classification_target_cols | tojson | default(categorical_cols) }};
  const selectedOptions = {{ selected_options | tojson | default({}) }};

  // --- Model Options ---
  const modelOptions = {
    regression: [
      "Linear Regression",
      "Random Forest Regressor",
      "Gradient Boosting Regressor",
      "XGBoost Regressor",
      "SVR"

      // Must match keys in modeling_utils.py
    ],
    classification: [
      "Logistic Regression",
      "Random Forest Classifier",
      "Gradient Boosting Classifier",
      "XGBoost Classifier",
      "KNN Classifier",
      "Decision Tree Classifier"
      // Must match keys in modeling_utils.py
    ]
  };

  function fillSelect(selectEl, items, selectedVal) {
    selectEl.innerHTML = "";
    items.forEach(item => {
      const o = document.createElement("option");
      o.value = o.text = item;
      if (item === selectedVal) {
        o.selected = true;
      }
      selectEl.appendChild(o);
    });
  }
  
  function fillMultiSelect(selectEl, items, selectedItems = []) {
    selectEl.innerHTML = "";
    items.forEach(item => {
      const o = document.createElement("option");
      o.value = o.text = item;
      if (selectedItems.includes(item)) {
        o.selected = true;
      }
      selectEl.appendChild(o);
    });
  }

  function onProblemTypeChange() {
    const problemType = document.getElementById("problem_type").value;
    const targetSelect = document.getElementById("target");
    const modelSelect = document.getElementById("model_name");

    // 1. Populate Target Dropdown
    if (problemType === 'regression') {
      fillSelect(targetSelect, numericCols, selectedOptions.target);
    } else if (problemType === 'classification') {
      // VVVV THIS IS THE FIX VVVV
      // Use the new list that contains both categorical and low-cardinality numeric columns
      fillSelect(targetSelect, classificationTargetCols, selectedOptions.target);

    } else {
      targetSelect.innerHTML = "<option value=''>-- Select Problem Type First --</option>";
    }

    // 2. Populate Model Dropdown
    if (modelOptions[problemType]) {
      fillSelect(modelSelect, modelOptions[problemType], selectedOptions.model_name);
    } else {
      modelSelect.innerHTML = "<option value=''>-- Select Problem Type First --</option>";
    }
    
    // 3. Update Features
    onTargetChange();
  }

  function onTargetChange() {
    const target = document.getElementById("target").value;
    const featureSelect = document.getElementById("features");
    
    // Populate features with all columns *except* the selected target
    const featureItems = allCols.filter(col => col !== target);
    fillMultiSelect(featureSelect, featureItems, selectedOptions.features);
  }

  // --- Initial Load ---
  document.addEventListener("DOMContentLoaded", () => {
    // Set initial state based on re-loaded POST data
    if (selectedOptions.problem_type) {
      onProblemTypeChange();
      onTargetChange();
    }
  });
</script>

</body>
</html>